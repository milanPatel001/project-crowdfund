//server

//http module to create http server, it's a part of node.js and uses tcp connection
const http = require("http");
//socket.io for real time bidirectional communication between server and client, also uses tcp
const socketIO = require("socket.io");

//creating http server
const server = http.createServer();

//initialize socket.io and passing http server as argument to socketIO
//which gives io instant which can be used to listen for incoming socket connection and events
const ioserver = socketIO(server, {
  cors: {
    origin: "*",
  },
});

//Port number that server listens for incoming connection
const port = 3000;

const fundsData = [
  {
    id: 0,
    name: "ABC Corp. 1",
    story:
      "sadasdasdadsd sdfsfsdf sok oobokof dfsdf ssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP ME SOMEPEOEOEOEOEEE OK boooooe",
    created_at: "10 Aug 2023",
    goal: 25000,
    donation_num: 0,
    total_donation: 10000,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 1,
    name: "ABC Corp. 2",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 2,
    name: "ABC Corp. 3",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 3,
    name: "ABC Corp. 4",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 4,
    name: "ABC Corp. 5",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 5,
    name: "ABC Corp. 6",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 6,
    name: "ABC Corp. 7",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 7,
    name: "ABC Corp. 8",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 8,
    name: "ABC Corp. 9",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 9,
    name: "ABC Corp. 10",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 10,
    name: "ABC Corp. 11",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
  {
    id: 11,
    name: "ABC Corp. 12",
    story: "---------------------------sadasdasdad",
    beneficiaryName: "MR. X",
    place: "BUFFALO, NY",
    title: "HELP",
    img: "",
    created_at: "yesterday",
    goal: 25000,
    donation_num: 0,
    total_donation: 0,
    recentDonators: [
      {
        donator: "MRS. JAMES",
        amount: 40,
      },
    ],
    comments: [
      {
        donator: "MR. Y",
        amount: 230,
        comment: "sdadadadasd",
      },
    ],
  },
];

//Stores top donations (use a priority queue)
const fundsLeaderboard = [
  {
    donator: "Mr. Z",
    amount: 240,
  },
  {
    donator: "Mr. A",
    amount: 56,
  },
];

ioserver.on("connection", (socket) => {
  console.log(
    "Client",
    socket.request.connection.remoteAddress,
    "is connected."
  );

  //listens for any donations by clients and then stores them
  socket.on("donate", (donationData) => {
    console.log(
      "Client",
      socket.request.connection.remoteAddress,
      "donated $",
      donationData.amount,
      "to",
      fundsData[donationData.index].beneficiaryName
    );

    //adding to total amount
    fundsData[donationData.index].total_donation += donationData.amount;

    //pushing to recent donations and top donations arr
    fundsData[donationData.index].recentDonators.unshift({
      donator: donationData.donator,
      amount: donationData.amount,
    });

    //broadcasts to every client
    ioserver.emit("donation", {
      socketId: socket.request.connection.remoteAddress,
      amount: donationData.amount,
      fundIndex: donationData.index,
    });
  });

  socket.on("fundsData request", () => {
    socket.emit("fundsData response", fundsData);
  });

  socket.on("donation amount request", (data) => {
    socket.emit("donation amount value", {
      value: fundsData[data.index].total_donation,
    });
  });

  socket.on("quit", () => {
    socket.disconnect();
  });

  //Server listens for the disconnect event
  //when disconnects it closes tcp connection
  socket.on("disconnect", () => {
    console.log(
      "Client",
      socket.request.connection.remoteAddress,
      "just disconnected."
    );
  });
});

//it starts the server that listen to a specified port
server.listen(port, () => {
  console.log(`Server running on port ${port}`);
});
